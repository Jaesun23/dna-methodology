# Stage 2: 환경 제약 가이드 (Environment Constraints Guide)

> **목적**: Stage 1의 패밀리/NFR이 현실 환경에서 구현 가능한지 확인하고, 충돌 발견 시 트레이드오프 결정
>
> **버전**: v5.0 (2025-12-03)
>
> - v5.0 (2025-12-03): Gemini 연구 기반 전면 재작성, DNA_METHODOLOGY_DETAILED.md 기준
> - v4.0 (2025-11-14): Stage 2 구조 확립

---

## 📚 이 가이드의 위치

```
DNA 방법론 문서 체계:

Tier 1: DNA_PROJECT_OVERVIEW_v2.md (전체 맥락)
           ↓
Tier 2: DNA_METHODOLOGY_DETAILED.md (상세 원리)
           ↓
Tier 3: 이 문서 (Stage 2 실행 가이드) ← 지금 여기!
```

**참조 문서**:
- **원리 이해**: `DNA_METHODOLOGY_DETAILED.md` Part 3.2
- **실전 사례**: `./02E-01_stock_trading_case.md`

---

## 📥 입력 문서

### Stage 1에서 전달받는 것

| 파일 | 핵심 내용 | 이 Stage에서 사용 |
|------|----------|-----------------|
| `01C-01_family_classification.md` | 패밀리 코드, 10가지 ADQ 답변 | Layer 3 목표 확인 |
| `01C-02_nfr_profile.md` | NFR 프로파일 | 충돌 패턴 분석 기준 |
| `01D-01_tech_candidates.md` | 기술 후보군 | 기술 스택 결정 입력 |

---

## 📤 출력 문서

### 필수 산출물 (3개)

| 파일명 | 내용 | 다음 Stage 전달 |
|--------|------|----------------|
| `02C-01_external_constraints.md` | 외부 제약 조사 결과 | ✅ API, 규제, 인프라 제약 |
| `02C-02_conflict_patterns.md` | 충돌 패턴 분석 | ✅ 트레이드오프 결정 |
| `02D-01_tech_stack.md` | 기술 스택 최종 결정 | ✅ ADR 작성 기반 |

---

## 🎯 Stage 2가 필요한 이유

> **"이상과 현실 사이의 간극 파악"**

Stage 1에서 결정한 패밀리와 NFR은 **이상적 목표**입니다.
Stage 2에서는 **현실의 제약**을 조사하여 충돌을 발견하고 해결합니다.

```
예시: 주식 거래 플랫폼

Stage 1 결정:
├─ 패밀리: A-A-B (트랜잭션/CRUD)
├─ NFR 프로파일: A-B-B-A (정확성, 중규모, 민감, 실시간)
└─ 목표: "100개 조건을 실시간 감시"

Stage 2 조사:
├─ 한국투자증권 API: 초당 20건 제한 ❌
├─ WebSocket: 최대 41개 종목 ❌
└─ 현실: "100개 동시 감시 불가능!"

충돌 발견! → 트레이드오프 필요
├─ 옵션 A: 감시 종목 41개로 축소
├─ 옵션 B: Polling + WebSocket 하이브리드
└─ 옵션 C: 목표 조정 (초단위 → 분단위)
```

---


## Part 1: 외부 제약 조사

Stage 1의 Q8-Q10 답변을 심화 조사합니다.

### 외부 제약 조사 체크리스트

#### 1. API/연동 제약 (Q8 심화)

```
조사 항목:
[ ] 사용할 외부 API 목록
[ ] 각 API의 호출 제한 (rate limit)
[ ] 인증 방식 (OAuth, API Key, 인증서)
[ ] 응답 시간 SLA
[ ] 장애 시 대응 방안
[ ] 문서화 수준 및 지원 품질
```

**작성 예시**:
```markdown
## API 제약 조사: 증권 거래 API

| 항목 | 한국투자증권 | 키움증권 |
|------|------------|---------|
| 호출 제한 | 실전 20건/초, 모의 2건/초 | 5건/초 |
| 인증 방식 | OAuth 2.0 + 앱키 | HTS ID/PW |
| 평균 응답 | 200-400ms | 300-600ms |
| WebSocket | ✅ (41개 종목) | ❌ |
| SLA | 99.9% | 99.5% |
```

---

#### 2. 규제/법적 제약

```
조사 항목:
[ ] 적용되는 법규 목록
[ ] 데이터 보관 요건 (기간, 형식)
[ ] 감사 로그 요건
[ ] 암호화 요건
[ ] 지역 제한 (데이터 거주지)
[ ] 인증/면허 요건
```

**산업별 주요 규제**:

| 산업 | 주요 규제 | 핵심 요건 |
|------|----------|----------|
| **금융** | 전자금융거래법, PCI-DSS | 거래 기록 5년, 이상거래 탐지 |
| **의료** | HIPAA, 개인정보보호법 | PHI 암호화, 접근 로그 |
| **교육** | FERPA | 학생 정보 보호 |
| **일반** | GDPR, 개인정보보호법 | 동의, 삭제권, 국외 이전 제한 |

---

#### 3. 인프라 제약 (Q9 심화)

```
조사 항목:
[ ] 클라우드 제공자 제한 (AWS/GCP/Azure/온프레미스)
[ ] 가용 리전 (데이터 거주지 요건)
[ ] 네트워크 대역폭
[ ] 스토리지 용량/비용
[ ] 기존 인프라 연동 요건
[ ] 예산 한도
```

**작성 예시**:
```markdown
## 인프라 제약

- 클라우드: AWS 허용 (금융권 승인됨)
- 리전: 서울 필수 (데이터 국외 반출 금지)
- 예산: 월 50만원 이하
- 기존 인프라: 없음 (신규 프로젝트)
```

---

#### 4. 시간 제약

```
조사 항목:
[ ] 서비스 운영 시간
[ ] 배치 처리 시간 윈도우
[ ] 유지보수 허용 시간
[ ] 마감 시간 (정산, 리포트)
[ ] 시장 시간 (거래소, 외부 시스템)
```

**작성 예시**:
```markdown
## 시간 제약

- 시장 시간: 09:00-15:30 (정규), 15:40-18:00 (시간외)
- 배치 윈도우: 18:00-09:00 (야간)
- 유지보수: 주말 00:00-06:00
- 정산 마감: 매일 18:00
```

---


## Part 2: 충돌 패턴 식별

Part 1의 **현실적 제약**과 Stage 1의 **이상적 목표(NFR)** 사이의 충돌을 분석합니다.

### 4가지 공통 충돌 패턴

#### 충돌 1: 정확성 vs 속도 (CAP Theorem의 C vs A)

```
상황: 강한 일관성을 원하지만 낮은 지연시간도 필요

예시:
├─ 목표: "잔고 조회는 항상 정확해야 함" (정확성)
├─ 목표: "조회 응답은 100ms 이하" (속도)
└─ 충돌: 동기화 대기 vs 캐시 사용

해결 전략:
├─ 쓰기: 동기식 (정확성 보장)
├─ 읽기: 캐시 + 비동기 (속도 확보)
├─ 중요 작업만 동기, 나머지 비동기
└─ Read-after-Write 일관성 적용
```

---

#### 충돌 2: 가용성 vs 정확성 (CAP Theorem의 A vs C)

```
상황: 항상 응답해야 하지만 항상 정확해야 함

예시:
├─ 목표: "시스템은 24/7 응답 가능" (가용성)
├─ 목표: "거래 금액은 절대 틀리면 안 됨" (정확성)
└─ 충돌: 네트워크 장애 시 어떻게 할 것인가?

해결 전략:
├─ 네트워크 정상: 둘 다 만족
├─ 네트워크 장애: 정확성 우선 (금융)
├─ Saga 패턴: 분산 트랜잭션 관리
└─ Outbox 패턴: 이벤트 유실 방지
```

---

#### 충돌 3: 성능 vs 비용

```
상황: 최고 성능을 원하지만 운영비 제한

예시:
├─ 목표: "피크 시간에도 1초 이내 응답"
├─ 제약: "월 예산 50만원 이하"
└─ 충돌: 상시 고성능 인스턴스 vs 비용

해결 전략:
├─ 오토스케일링: 피크 시간만 확장
├─ 예약 인스턴스: 기본 용량 확보
├─ 스팟 인스턴스: 비용 절감 (배치용)
└─ 비용 상한선 알림 설정
```

---

#### 충돌 4: 보안 vs 사용성

```
상황: 강한 보안이 필요하지만 편리한 사용도 원함

예시:
├─ 목표: "모든 거래는 2단계 인증" (보안)
├─ 목표: "빠른 조회/주문 경험" (사용성)
└─ 충돌: 매번 MFA vs 원클릭 주문

해결 전략:
├─ 조회: 간단한 인증 (세션 기반)
├─ 거래: MFA 필수
├─ 위험 기반 인증: 이상 징후 시만 추가 인증
└─ 세션 유효 기간 차등 적용
```

---

### 충돌 분석 템플릿

각 충돌마다 다음 형식으로 분석:

```markdown
### 충돌 #N: [목표 vs 제약]

**NFR 목표** (Stage 1):
- [NFR 프로파일에서 정한 목표]

**현실 제약** (Part 1 조사 결과):
- [외부 제약 조사에서 발견한 제약]

**충돌 상황**:
- [왜 불가능한가? 구체적 수치로]

**영향 분석**:
- 이 충돌을 무시하면: [결과]
- 이 충돌을 해결하면: [기대 효과]

**트레이드오프 옵션**:
| 옵션 | 설명 | 장점 | 단점 |
|------|------|------|------|
| A | [방법 1] | [장점] | [단점] |
| B | [방법 2] | [장점] | [단점] |
| C | [방법 3] | [장점] | [단점] |

**선택**: [옵션 X]
**근거**: [선택 이유]
```

---


## Part 3: 기술 스택 결정

Stage 1의 기술 후보군 + Part 1의 제약 + Part 2의 충돌 해결을 종합하여 최종 기술 스택을 결정합니다.

### 기술 스택 결정 3단계

#### 단계 1: 패밀리 기반 후보군 확인

```
Stage 1에서 결정된 패밀리 기반 기술 후보군 확인

예시: A-A-B (트랜잭션/CRUD) 패밀리

참조: ./family-tech-matrix/02_transaction_crud_tech_options.md

후보 DB:
├─ PostgreSQL: ACID, JSON 지원, 성숙
├─ MySQL: ACID, 대중적, Aurora 옵션
└─ CockroachDB: 분산 ACID, 글로벌

후보 프레임워크:
├─ FastAPI: 비동기, 타입 안전, 현대적
├─ Django: 풀스택, ORM 내장, 성숙
└─ Spring Boot: 엔터프라이즈, Java
```

---

#### 단계 2: 제약조건 필터링

```
Part 1 조사 결과로 후보군 필터링

필터링 기준:
├─ 팀 역량: Python 중심 → Java 제외
├─ 비용 제한: 오픈소스 우선 → Oracle 제외
├─ 규제 요건: 국내 서버 → 글로벌 분산 DB 제한
├─ 기존 인프라: 없음 → 제약 없음
└─ 성능 요건: 비동기 필수 → Django 제외

필터링 결과:
├─ DB: PostgreSQL ✅
├─ Framework: FastAPI ✅
└─ Cache: Redis ✅
```

---

#### 단계 3: 충돌 해결 반영

```
Part 2의 트레이드오프 결정을 기술 스택에 반영

예시:
├─ 충돌 1 (정확성 vs 속도) 해결:
│   → Redis 캐시 도입 (읽기 속도)
│   → PostgreSQL 트랜잭션 유지 (쓰기 정확성)
│
├─ 충돌 3 (성능 vs 비용) 해결:
│   → AWS t3.medium 시작
│   → 오토스케일링 설정
│
└─ 충돌 4 (보안 vs 사용성) 해결:
    → JWT + Refresh Token
    → 거래 시 추가 인증
```

---

### 기술 스택 문서화 형식

```markdown
## 최종 기술 스택

### 핵심 선택

| 영역 | 선택 | 대안 | 선택 근거 |
|------|------|------|----------|
| 언어 | Python 3.11+ | - | 팀 역량, 에코시스템 |
| 프레임워크 | FastAPI | Django | 비동기, 타입 안전 |
| DB | PostgreSQL 15 | MySQL | ACID, JSON, 성숙도 |
| 캐시 | Redis | Memcached | 데이터 구조, 지속성 |
| 메시징 | Redis Streams | Kafka | 규모 적합, 단순성 |

### DNA 시스템 기술

| DNA 시스템 | 기술 | 비고 |
|-----------|------|------|
| Testing | pytest + pytest-cov | 95% 커버리지 목표 |
| Code Quality | Ruff + MyPy | 0 violations |
| Observability | structlog | JSON, trace_id |
| Configuration | pydantic-settings | 타입 안전 |
| Resilience | tenacity | 재시도, Circuit Breaker |

### 인프라

| 영역 | 선택 | 비고 |
|------|------|------|
| 클라우드 | AWS Seoul | 규제 요건 |
| 컴퓨팅 | ECS Fargate | 서버리스 컨테이너 |
| DB | RDS PostgreSQL | 관리형 |
| 캐시 | ElastiCache Redis | 관리형 |
```

---


## 📋 템플릿

### 02C-01_external_constraints.md 템플릿

```markdown
# 외부 제약 조건

**프로젝트**: [프로젝트명]
**작성일**: [YYYY-MM-DD]
**작성자**: [이름]

---

## 1. API/연동 제약

### 1.1 외부 API 목록

| API | 용도 | 호출 제한 | 인증 | 응답 시간 |
|-----|------|----------|------|----------|
| [API 1] | [용도] | [제한] | [방식] | [시간] |
| [API 2] | [용도] | [제한] | [방식] | [시간] |

### 1.2 연동 시 제약사항
- [제약 1]
- [제약 2]

---

## 2. 규제/법적 제약

### 2.1 적용 법규
- [법규 1]: [핵심 요건]
- [법규 2]: [핵심 요건]

### 2.2 데이터 보관 요건
| 데이터 유형 | 보관 기간 | 형식 | 근거 법규 |
|------------|----------|------|----------|
| [유형 1] | [기간] | [형식] | [법규] |

### 2.3 암호화 요건
- [요건 1]
- [요건 2]

---

## 3. 인프라 제약

### 3.1 클라우드/서버
- 허용 클라우드: [AWS/GCP/Azure/온프레미스]
- 필수 리전: [리전명]
- 이유: [데이터 거주지 등]

### 3.2 예산
- 초기 예산: [금액]
- 월 운영비: [금액]

### 3.3 기존 인프라
- [연동 필요한 기존 시스템]

---

## 4. 시간 제약

### 4.1 서비스 운영 시간
- 정규: [시간]
- 시간외: [시간]

### 4.2 배치 처리 윈도우
- [시간대]

### 4.3 외부 시스템 시간
- [시장 시간, 정산 마감 등]
```

---

### 02C-02_conflict_patterns.md 템플릿

```markdown
# 충돌 패턴 분석

**프로젝트**: [프로젝트명]
**작성일**: [YYYY-MM-DD]

---

## NFR 달성 가능성 분석

### Stage 1 NFR 프로파일: [X-X-X-X]

| NFR | 목표 | 외부 제약 | 달성 가능? |
|-----|------|----------|-----------|
| [NFR 1] | [목표] | [제약] | ✅/⚠️/❌ |
| [NFR 2] | [목표] | [제약] | ✅/⚠️/❌ |

---

## 발견된 충돌 패턴

### 충돌 #1: [목표 vs 제약]

**NFR 목표**:
- [목표 설명]

**현실 제약**:
- [제약 설명]

**충돌 상황**:
- [구체적 수치로 설명]

**트레이드오프 옵션**:
| 옵션 | 설명 | 장점 | 단점 |
|------|------|------|------|
| A | [방법] | [장점] | [단점] |
| B | [방법] | [장점] | [단점] |

**선택**: [옵션]
**근거**: [이유]

---

### 충돌 #2: [목표 vs 제약]
[같은 형식으로 작성]

---

## 충돌 해결 요약

| 충돌 | 선택한 옵션 | Stage 3 ADR 필요? |
|------|-----------|------------------|
| #1 | [옵션] | ✅/❌ |
| #2 | [옵션] | ✅/❌ |
```

---

### 02D-01_tech_stack.md 템플릿

```markdown
# 기술 스택 결정

**프로젝트**: [프로젝트명]
**작성일**: [YYYY-MM-DD]

---

## 결정 과정

### 1. 패밀리 기반 후보군
- 패밀리: [코드] ([패밀리명])
- 참조: `./family-tech-matrix/[파일].md`

### 2. 제약조건 필터링
| 제약 | 영향 | 필터링 결과 |
|------|------|-----------|
| [제약 1] | [영향] | [제외된 기술] |

### 3. 충돌 해결 반영
| 충돌 | 해결 옵션 | 기술 영향 |
|------|----------|----------|
| [충돌 1] | [옵션] | [기술 추가/변경] |

---

## 최종 기술 스택

### 핵심 선택

| 영역 | 선택 | 대안 | 선택 근거 |
|------|------|------|----------|
| 언어 | [언어] | [대안] | [근거] |
| 프레임워크 | [프레임워크] | [대안] | [근거] |
| DB | [DB] | [대안] | [근거] |
| 캐시 | [캐시] | [대안] | [근거] |

### DNA 시스템 기술

| DNA 시스템 | 기술 | 설정 |
|-----------|------|------|
| Testing | [기술] | [설정] |
| Code Quality | [기술] | [설정] |
| Observability | [기술] | [설정] |
| Configuration | [기술] | [설정] |
| Resilience | [기술] | [설정] |

### 인프라

| 영역 | 선택 | 비고 |
|------|------|------|
| 클라우드 | [선택] | [비고] |
| 컴퓨팅 | [선택] | [비고] |
| DB | [선택] | [비고] |

---

## Stage 3 ADR 목록 (예정)

이 문서의 결정들은 Stage 3에서 ADR로 공식화됩니다:

- [ ] ADR-001: [DB 선택]
- [ ] ADR-002: [프레임워크 선택]
- [ ] ADR-003: [충돌 해결 전략]
```

---


## ✅ Stage 2 완료 체크리스트

```
□ Part 1: 외부 제약 조사 완료
  □ API/연동 제약 조사
  □ 규제/법적 제약 조사
  □ 인프라 제약 조사
  □ 시간 제약 조사

□ Part 2: 충돌 패턴 식별 완료
  □ NFR 달성 가능성 분석
  □ 충돌 패턴 식별 (최소 1개 이상)
  □ 각 충돌별 트레이드오프 옵션 도출
  □ 각 충돌별 선택 및 근거 문서화

□ Part 3: 기술 스택 결정 완료
  □ 패밀리 기반 후보군 확인
  □ 제약조건 필터링
  □ 충돌 해결 반영
  □ 최종 기술 스택 문서화

□ 산출물 생성:
  □ 02C-01_external_constraints.md
  □ 02C-02_conflict_patterns.md
  □ 02D-01_tech_stack.md

□ Stage 3 ADR 목록 작성
```

---

## 🔜 다음 단계

### Stage 2 → Stage 3 전달 사항

| 항목 | 예시 | Stage 3에서 사용 |
|------|------|-----------------|
| 외부 제약 | API 호출 제한, 규제 | ADR 카테고리 1 (외부 제약) |
| 충돌 해결 | 정확성 vs 속도 해결 | ADR 카테고리 2 (충돌 해결) |
| 기술 스택 | PostgreSQL, FastAPI | ADR 카테고리 3 (기술 스택) |
| ADR 목록 | 예정된 ADR 3개 | Stage 3 작업 범위 |

### Stage 3에서 할 일
- 🔄 ADR 카테고리별 작성
- 🔄 Bootstrap ADR (DNA 시스템)
- 🔄 Domain ADR (도메인 특화)
- 🔄 Design Doc → ADR 변환 (복잡한 결정)

**다음 문서**: `03G-00_adr_guide.md`

---

## 📚 참고 문서

| 문서 | 용도 |
|------|------|
| `DNA_METHODOLOGY_DETAILED.md` Part 3.2 | Stage 2 상세 원리 |
| `./family-tech-matrix/*.md` | 패밀리별 기술 선택 |
| `./02E-01_stock_trading_case.md` | 실전 사례 (주식 거래) |
| `./standards/00_STAGE_STRUCTURE.md` | Stage 간 연결 구조 |

---

## 💡 핵심 원칙 요약

```
Stage 2의 본질:

1. "이상과 현실의 간극 파악"
   - Stage 1의 NFR은 이상
   - Part 1 조사 결과는 현실
   - 간극 = 충돌

2. "충돌은 정상이다"
   - 모든 프로젝트에 충돌 존재
   - 중요한 것은 의식적 트레이드오프
   - 결정과 근거를 문서화

3. "기술 스택은 제약의 산물"
   - 이상적 기술 ≠ 최종 선택
   - 제약조건 필터링 후 남는 것이 정답
   - 선택 근거가 핵심
```

---

**버전 이력**:
- v5.0 (2025-12-03): Gemini 연구 기반 전면 재작성, DNA_METHODOLOGY_DETAILED.md 기준
- v4.0 (2025-11-14): Stage 2 구조 확립
- v3.0 (2025-11-12): 초기 버전
