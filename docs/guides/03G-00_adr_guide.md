# Stage 3: ADR 작성 가이드 (Architecture Decision Records Guide)

> **목적**: Stage 2에서 결정된 기술 스택과 충돌 해결을 공식 ADR로 문서화
>
> **버전**: v5.0 (2025-12-03)
>
> - v5.0 (2025-12-03): Gemini 연구 기반 전면 재작성, DNA_METHODOLOGY_DETAILED.md 기준
> - v3.0 (2025-11-13): Stage 3 분리

---

## 📚 이 가이드의 위치

```
DNA 방법론 문서 체계:

Tier 1: DNA_PROJECT_OVERVIEW_v2.md (전체 맥락)
           ↓
Tier 2: DNA_METHODOLOGY_DETAILED.md (상세 원리) - Part 4
           ↓
Tier 3: 이 문서 (Stage 3 실행 가이드) ← 지금 여기!
```

**참조 문서**:
- **원리 이해**: `DNA_METHODOLOGY_DETAILED.md` Part 4
- **실전 사례**: `IMPLEMENTATION_CASES.md`

---

## 🤔 왜 ADR이 필요한가?

### 문제 상황: "왜 이렇게 했지?"

```
6개월 후...

새로운 팀원: "왜 PostgreSQL인가요? MongoDB가 더 좋을 것 같은데..."
기존 팀원: "음... 그때 뭔가 이유가 있었는데..."

결과:
├─ 같은 논의 반복 (시간 낭비)
├─ 근거 없이 기술 변경 시도
├─ 변경 후 예상치 못한 문제 발생
└─ "그냥 원래대로 하자" (발전 없음)
```

### 실제 사례: 주식 거래 플랫폼

```
상황:
- Stage 2에서 "정확성 > 속도" 결정
- 주문 처리에 캐시 사용 안 함
- 조회에만 캐시 사용

6개월 후:
- 새 개발자: "주문도 캐시 쓰면 빨라질 텐데?"
- ADR 없다면 → 캐시 적용 → 금액 불일치 사고
- ADR 있다면 → ADR-101 확인 → "아, 이래서 안 쓰는구나"

ADR-101 정확성 우선 전략:
├─ 맥락: 주문 금액 정확성 필수
├─ 검토한 대안: 캐시 사용, 실시간 조회, 하이브리드
├─ 결정: 주문은 실시간, 조회만 캐시
├─ 결과: 500ms 느려지지만 정확도 100%
└─ 재검토 조건: 정확도 문제 발생 시
```

### ADR의 핵심 가치

| 가치 | 설명 | 없을 때 문제 |
|------|------|-------------|
| **기억** | 결정 근거 보존 | 왜 이렇게 했는지 모름 |
| **방지** | 같은 실수 반복 방지 | 이미 검토한 대안 재논의 |
| **속도** | 신규 인원 온보딩 | 모든 결정을 다시 설명 |
| **변경** | 영향 범위 파악 | 변경 시 뭐가 깨지는지 모름 |

---

## 📥 입력 문서

### Stage 2에서 전달받는 것

| 파일 | 핵심 내용 | 이 Stage에서 사용 |
|------|----------|-----------------|
| `02C-01_external_constraints.md` | 외부 제약 조사 | ADR 카테고리 1 |
| `02C-02_conflict_patterns.md` | 충돌 패턴 분석 | ADR 카테고리 2 |
| `02D-01_tech_stack.md` | 기술 스택 결정 | ADR 카테고리 3, 5 |

---

## 📤 출력 문서

### 필수 산출물

```
docs/adr/
├── 03A-000_adr_index.md           # ADR 목록 및 상태
├── category-1-external/           # 외부 제약 ADR
│   └── 03A-001_*.md ~ 03A-00N.md
├── category-2-conflict/           # 충돌 해결 ADR
│   └── 03A-101_*.md ~ 03A-1NN.md
├── category-3-tech-stack/         # 기술 스택 ADR
│   └── 03A-201_*.md ~ 03A-2NN.md
├── category-4-domain/             # 도메인 기술 ADR
│   └── 03A-301_*.md ~ 03A-3NN.md
└── category-5-dna-system/         # DNA 시스템 ADR
    └── 03A-401_*.md ~ 03A-4NN.md
```

---

## 🎯 ADR이란?

> **ADR = Architecture Decision Record**
> 
> "코드는 '무엇'을 보여주지만, ADR은 '왜'를 설명한다"

### ADR의 역할

```
왜 필요한가?
├─ 왜 이 결정을 했는지 기록
├─ 어떤 대안이 있었는지 기록
├─ 나중에 "왜 이렇게 했지?" 질문에 답변
└─ 결정 변경 시 영향 범위 파악
```

### ADR vs Design Doc

| 구분 | Design Doc | ADR |
|------|------------|-----|
| **목적** | 상세 분석 | 결정 기록 |
| **분량** | 10-50 페이지 | 1-2 페이지 |
| **내용** | 문제 정의, 대안 분석, 벤치마크 | 맥락, 결정, 결과 |
| **사용 시점** | 복잡한 결정 전 | 모든 결정 후 |
| **관계** | "어머니" 문서 | Design Doc의 "결론" |

**판단 기준**:
```
├─ 간단한 결정: ADR만 작성
│   예: "로깅은 structlog 사용"
│
├─ 복잡한 결정: Design Doc → ADR
│   예: "DB 선택 (PostgreSQL vs MySQL vs MongoDB)"
│
└─ 매우 복잡: RFC/KEP → Design Doc → ADR
    예: "마이크로서비스 vs 모놀리식"
```

---


## 5대 ADR 카테고리

### 카테고리 1: 외부 제약 ADR (001-099)

> **정의**: 변경할 수 없는 외부 요인에 의한 결정

```
특징:
├─ 우리가 선택할 수 없음
├─ 반드시 따라야 함
├─ 위반 시 시스템 작동 불가 또는 법적 문제
└─ "왜?"보다 "무엇?"이 중요
```

**예시**:
| 유형 | 예시 | ADR 제목 |
|------|------|---------|
| 법규 | 거래 기록 5년 보관 | ADR-001: 전자금융거래법 준수 |
| API 제한 | KIS API 초당 20회 | ADR-002: KIS API Rate Limit 대응 |
| 시장 시간 | KRX 정규장 09:00-15:30 | ADR-003: 시장 시간 기반 스케줄링 |
| 지역 제한 | 개인정보 국내 서버 필수 | ADR-004: 데이터 거주지 요건 |

---

### 카테고리 2: 충돌 해결 ADR (101-199)

> **정의**: 상충하는 요구사항 간 Trade-off 결정

```
특징:
├─ 둘 다 중요하지만 둘 다 만족 불가
├─ 하나를 선택하면 다른 하나 희생
├─ "왜 이걸 선택했나?"가 핵심
└─ 나중에 재검토 가능성 있음
```

**예시**:
| 충돌 | 결정 | ADR 제목 |
|------|------|---------|
| 정확성 vs 속도 | 주문=정확성, 조회=속도 | ADR-101: 정확성 우선 전략 |
| 일관성 vs 가용성 | CP 선택 (장애 시 거부) | ADR-102: CAP 선택 - CP |
| 보안 vs 편의성 | 거래=MFA, 조회=단순 | ADR-103: 인증 레벨 차등화 |
| 비용 vs 성능 | 피크=성능, 비피크=비용 | ADR-104: 오토스케일링 전략 |

---

### 카테고리 3: 기술 스택 ADR (201-299)

> **정의**: 여러 기술 대안 중 하나를 선택하는 결정

```
특징:
├─ 비교 가능한 대안 존재
├─ 정량적 비교 가능 (성능, 비용, 생태계)
├─ Context7 검증 필수
└─ 팀 역량, 생태계 고려
```

**예시**:
| 영역 | 선택 | 대안 | ADR 제목 |
|------|------|------|---------|
| DB | PostgreSQL | MySQL, MongoDB | ADR-201: PostgreSQL 선택 |
| 프레임워크 | FastAPI | Django, Flask | ADR-202: FastAPI 선택 |
| 메시지 큐 | Redis Streams | Kafka, RabbitMQ | ADR-203: Redis Streams 선택 |
| 캐시 | Redis | Memcached | ADR-204: Redis 캐시 선택 |

---

### 카테고리 4: 도메인 기술 ADR (301-399)

> **정의**: 프로젝트 특화 로직/알고리즘 설계 결정

```
특징:
├─ 외부 라이브러리로 해결 안 됨
├─ 자체 설계/구현 필요
├─ 비즈니스 로직 깊숙이 관련
└─ 성능/정확도가 핵심
```

**예시**:
| 영역 | 설계 내용 | ADR 제목 |
|------|----------|---------|
| 주문 처리 | 상태 머신, 재시도 전략 | ADR-301: 주문 실행 전략 |
| 데이터 모델 | 주문 스키마, 관계 | ADR-302: 주문 데이터 모델 |
| API 설계 | 엔드포인트, 응답 형식 | ADR-303: REST API 설계 |
| 동시성 | 낙관적 락, 충돌 해결 | ADR-304: 동시성 제어 전략 |

---

### 카테고리 5: DNA 시스템 ADR (401-499)

> **정의**: 프로젝트 공통 인프라/표준 결정

```
특징:
├─ 전체 프로젝트에 영향
├─ Stage 4-6 (Bridge)에서 구현
├─ 일관성이 핵심
└─ 변경 시 영향 범위 큼
```

**예시**:
| 시스템 | 결정 내용 | ADR 제목 |
|--------|----------|---------|
| 로깅 | structlog + JSON | ADR-401: 로깅 표준화 |
| 에러 처리 | 예외 계층 + 에러 코드 | ADR-402: 에러 처리 표준 |
| 설정 관리 | Pydantic Settings | ADR-403: 설정 관리 표준 |
| 테스트 | pytest + 95% 커버리지 | ADR-404: 테스트 전략 |
| 인증 | JWT + RS256 | ADR-405: 인증 표준 |

---


## ADR 작성 우선순위

### 권장 순서

```
Phase 1: 외부 제약 ADR (카테고리 1)
────────────────────────────────────
- 가장 먼저 작성 (변경 불가능)
- Stage 2 02C-01_external_constraints.md 기반
- 다른 ADR의 제약 조건이 됨

Phase 2: 충돌 해결 ADR (카테고리 2)
────────────────────────────────────
- 외부 제약 기반 해결책
- Stage 2 02C-02_conflict_patterns.md 기반
- 기술 스택 선택에 영향

Phase 3: 기술 스택 ADR (카테고리 3)
────────────────────────────────────
- Stage 2 02D-01_tech_stack.md 기반
- 핵심 기술 선택 근거

Phase 4: DNA 시스템 ADR (카테고리 5)
────────────────────────────────────
- 공통 인프라 결정
- Stage 4-6에서 구현할 내용

Phase 5: 도메인 기술 ADR (카테고리 4)
────────────────────────────────────
- 비즈니스 로직 설계
- Stage 7-9에서 구현할 내용
```

---

## 📋 ADR 템플릿

### 표준 ADR 템플릿

```markdown
# ADR-XXX: {Decision Title}

**상태**: Proposed | Accepted | Deprecated | Superseded
**작성일**: YYYY-MM-DD
**카테고리**: 외부제약 | 충돌해결 | 기술스택 | 도메인기술 | DNA시스템

---

## 맥락 (Context)

왜 이 결정이 필요한가?
- 문제 상황
- 제약 조건
- 요구사항

## 검토한 대안 (Alternatives)

### 대안 1: [이름]
- 설명: ...
- 장점: ...
- 단점: ...

### 대안 2: [이름]
- 설명: ...
- 장점: ...
- 단점: ...

### 대안 3: [이름]
- 설명: ...
- 장점: ...
- 단점: ...

## 결정 (Decision)

**선택**: [대안 N]

**핵심 근거**:
1. [이유 1]
2. [이유 2]
3. [이유 3]

## 결과 (Consequences)

### 긍정적 영향
- ✅ [영향 1]
- ✅ [영향 2]

### 트레이드오프
- ⚠️ [트레이드오프 1]
- ⚠️ [트레이드오프 2]

### 부정적 영향
- ❌ [영향 1] (해결 방안: ...)

## 후속 조치 (Follow-up)

- [ ] [조치 1]
- [ ] [조치 2]

## 참조 (References)

- Stage 2 문서: `02C-01_external_constraints.md`
- 관련 ADR: ADR-XXX
- 외부 링크: [URL]
```

---

### 카테고리별 템플릿 변형

#### 외부 제약 ADR (간소화)

```markdown
# ADR-00X: [외부 제약 제목]

**상태**: Accepted
**카테고리**: 외부제약
**작성일**: YYYY-MM-DD

---

## 제약 조건

| 항목 | 내용 |
|------|------|
| 출처 | [법규/API/규제 등] |
| 제약 내용 | [구체적 제약] |
| 위반 시 영향 | [결과] |

## 대응 방안

[제약을 준수하기 위한 구현 방안]

## 결과

- 모든 [관련 기능]은 [제약]을 준수해야 함
- [구현 위치/방법]
```

---

#### 기술 스택 ADR (비교표 포함)

```markdown
# ADR-2XX: [기술 선택 제목]

**상태**: Accepted
**카테고리**: 기술스택
**작성일**: YYYY-MM-DD

---

## 맥락

[왜 이 기술이 필요한가]

## 대안 비교

| 기준 | [기술 A] | [기술 B] | [기술 C] |
|------|---------|---------|---------|
| 성능 | ⭐⭐⭐ | ⭐⭐ | ⭐ |
| 비용 | 무료 | 무료 | $$$ |
| 팀 경험 | ✅ 있음 | ⚠️ 적음 | ❌ 없음 |
| 생태계 | ✅ 풍부 | ⚠️ 보통 | ⚠️ 보통 |
| [기타 기준] | ... | ... | ... |

## 결정

**선택**: [기술 A]

**핵심 근거**:
1. [이유 1]
2. [이유 2]

## 결과

- [구현에 미치는 영향]
- [함께 사용할 라이브러리]
```

---


### ADR Index 템플릿 (03A-000_adr_index.md)

```markdown
# ADR Index

**프로젝트**: [프로젝트명]
**최종 업데이트**: YYYY-MM-DD
**총 ADR 수**: [N]개

---

## 상태별 요약

| 상태 | 개수 |
|------|------|
| Proposed | N |
| Accepted | N |
| Deprecated | N |
| Superseded | N |

---

## 카테고리 1: 외부 제약 (001-099)

| 번호 | 제목 | 상태 | 작성일 |
|------|------|------|--------|
| ADR-001 | [제목] | Accepted | YYYY-MM-DD |
| ADR-002 | [제목] | Accepted | YYYY-MM-DD |

---

## 카테고리 2: 충돌 해결 (101-199)

| 번호 | 제목 | 충돌 유형 | 상태 | 작성일 |
|------|------|----------|------|--------|
| ADR-101 | [제목] | 정확성 vs 속도 | Accepted | YYYY-MM-DD |

---

## 카테고리 3: 기술 스택 (201-299)

| 번호 | 제목 | 영역 | 선택 | 상태 |
|------|------|------|------|------|
| ADR-201 | [제목] | DB | PostgreSQL | Accepted |
| ADR-202 | [제목] | Framework | FastAPI | Accepted |

---

## 카테고리 4: 도메인 기술 (301-399)

| 번호 | 제목 | 도메인 | 상태 |
|------|------|--------|------|
| ADR-301 | [제목] | 주문 | Accepted |

---

## 카테고리 5: DNA 시스템 (401-499)

| 번호 | 제목 | 시스템 | 상태 |
|------|------|--------|------|
| ADR-401 | [제목] | 로깅 | Accepted |
| ADR-402 | [제목] | 에러처리 | Accepted |

---

## 의존성 그래프

```
ADR-001 (외부제약)
    ↓
ADR-101 (충돌해결) ← ADR-002 (외부제약)
    ↓
ADR-201 (기술스택)
    ↓
ADR-401 (DNA시스템)
```
```

---

## 📝 ADR 작성 예시 (주식 거래 플랫폼)

### 예시 1: 외부 제약 ADR

```markdown
# ADR-002: KIS API 호출 제한 대응

**상태**: Accepted
**카테고리**: 외부제약
**작성일**: 2024-01-15

---

## 제약 조건

| 항목 | 내용 |
|------|------|
| 출처 | 한국투자증권 KIS API 문서 |
| 제약 내용 | 초당 20회 호출 제한, 초과 시 일시 차단 |
| 위반 시 영향 | API 차단으로 서비스 중단 |

## 대응 방안

1. Rate Limiter 구현
   - 초당 15회로 제한 (5회 여유분)
   - Token Bucket 알고리즘 사용
   
2. 요청 큐잉
   - 초과 요청은 큐에 대기
   - 최대 대기 시간: 5초

3. 벌크 요청 최적화
   - 여러 종목 조회 → 배치 API 활용

## 결과

- core/external/kis_client.py에 RateLimiter 구현
- 모든 KIS API 호출은 rate_limiter를 거쳐야 함
- 모니터링: 초당 호출 수, 큐 대기 시간
```

---

### 예시 2: 충돌 해결 ADR

```markdown
# ADR-101: 정확성 우선 전략

**상태**: Accepted
**카테고리**: 충돌해결
**작성일**: 2024-01-15

---

## 맥락

주문 처리에서 정확성(금액 정확)과 속도(빠른 응답)가 충돌.
캐시 사용 시 속도↑ but 정확성 위험.

## 검토한 대안

### 대안 1: 캐시 전면 사용
- 장점: 응답 속도 200ms → 50ms
- 단점: 가격 불일치 가능, 금융 사고 위험
- 거부 이유: 금융 거래에서 정확성 타협 불가

### 대안 2: 실시간 조회 전면 사용
- 장점: 100% 정확
- 단점: 모든 요청 500ms, 시세 조회도 느림
- 거부 이유: 시세 조회까지 느릴 필요 없음

### 대안 3: 하이브리드 (선택)
- 주문 관련: 항상 실시간
- 시세 조회: 1초 캐시 허용
- 장점: 정확성 + 사용성 균형

## 결정

**선택**: 대안 3 (하이브리드)

**핵심 근거**:
1. 주문 정확성은 금융 서비스의 핵심 가치
2. 시세 조회는 1초 지연 허용 가능
3. 사용자 경험과 안전성 균형

## 결과

### 긍정적 영향
- ✅ 주문 금액 100% 정확
- ✅ 시세 조회 응답 속도 개선

### 트레이드오프
- ⚠️ 주문 응답 500ms (캐시 사용 시 50ms)

### 부정적 영향
- ❌ 구현 복잡도 증가 (해결: 명확한 분리 설계)

## 재검토 조건

- 주문 응답 시간이 1초 초과 시
- 정확도 관련 이슈 발생 시
```

---

### 예시 3: 기술 스택 ADR

```markdown
# ADR-201: PostgreSQL 선택

**상태**: Accepted
**카테고리**: 기술스택
**작성일**: 2024-01-15

---

## 맥락

CRUD/트랜잭션 패밀리(A-A-B)로, ACID 준수 DB 필요.
주문, 계좌, 포트폴리오 데이터 저장.

## 대안 비교

| 기준 | PostgreSQL | MySQL | MongoDB |
|------|------------|-------|---------|
| ACID | ✅ 완전 지원 | ✅ 지원 | ⚠️ 제한적 |
| JSON 지원 | ✅ JSONB | ⚠️ JSON | ✅ 네이티브 |
| 복잡 쿼리 | ✅ 우수 | ⚠️ 보통 | ❌ 제한적 |
| 비용 | 무료 | 무료 | Atlas$$$ |
| 팀 경험 | ✅ 있음 | ✅ 있음 | ⚠️ 적음 |
| 비동기 | asyncpg | aiomysql | motor |

## 결정

**선택**: PostgreSQL 15

**핵심 근거**:
1. ACID 완전 지원 (금융 거래 필수)
2. JSONB로 유연한 스키마 가능 (설정, 메타데이터)
3. 팀 경험 있음, 생태계 풍부

## 결과

- ORM: SQLAlchemy 2.0 (async 지원)
- 마이그레이션: Alembic
- 연결: asyncpg (비동기)
- 풀링: connection pool size 20
```

---

## ✅ Stage 3 완료 체크리스트

```
□ ADR 구조 설정
  □ docs/adr/ 디렉토리 생성
  □ 카테고리별 하위 디렉토리 생성
  □ 03A-000_adr_index.md 생성

□ 카테고리 1: 외부 제약 ADR
  □ Stage 2 02C-01 기반 작성
  □ 법규, API 제한, 시간 제약 등
  □ 최소 1개 이상

□ 카테고리 2: 충돌 해결 ADR
  □ Stage 2 02C-02 기반 작성
  □ 각 충돌 패턴별 해결 전략
  □ 최소 1개 이상

□ 카테고리 3: 기술 스택 ADR
  □ Stage 2 02D-01 기반 작성
  □ DB, 프레임워크, 캐시 등
  □ 주요 기술별 1개씩

□ 카테고리 4: 도메인 기술 ADR
  □ 핵심 비즈니스 로직 설계
  □ 데이터 모델, API 설계

□ 카테고리 5: DNA 시스템 ADR
  □ 로깅, 에러 처리, 설정 관리
  □ 테스트, 인증 전략

□ ADR Index 업데이트
  □ 모든 ADR 등록
  □ 상태별 요약
  □ 의존성 그래프
```

---

## 🔜 다음 단계

### Stage 3 → Stage 4 전달 사항

| 항목 | 예시 | Stage 4에서 사용 |
|------|------|-----------------|
| DNA 시스템 ADR | ADR-401~499 | DNA 시스템 청사진 |
| 기술 스택 ADR | ADR-201~299 | 개발 환경 설정 |
| 도메인 기술 ADR | ADR-301~399 | 도메인 청사진 |

### Stage 4에서 할 일
- 🔄 DNA 시스템 ADR 기반 청사진 작성
- 🔄 src/core/ 모듈 구조 설계
- 🔄 공통 컴포넌트 인터페이스 정의

**다음 문서**: `04G-00_dna_system_blueprint_guide.md`

---

## 📚 참고 문서

| 문서 | 용도 |
|------|------|
| `DNA_METHODOLOGY_DETAILED.md` Part 4 | Stage 3 상세 원리 |
| `IMPLEMENTATION_CASES.md` | ADR 실전 사례 |
| `./standards/00_STAGE_STRUCTURE.md` | Stage 간 연결 구조 |

---

## 💡 핵심 원칙 요약

```
ADR 작성의 3가지 원칙:

1. "왜"를 기록
   - 코드는 "무엇"을 보여줌
   - ADR은 "왜"를 설명
   - 나중에 질문에 답할 수 있어야 함

2. 대안을 기록
   - 선택한 것만 기록 ❌
   - 검토한 대안과 거부 이유도 기록 ✅
   - 재검토 시 불필요한 반복 방지

3. 결과를 예측
   - 긍정적 영향
   - 트레이드오프
   - 부정적 영향과 완화 방안
```

```
카테고리 분류 원칙:

1. 외부 제약: "변경 불가, 따라야 함"
2. 충돌 해결: "둘 다 원하지만 선택해야 함"
3. 기술 스택: "여러 대안 중 하나 선택"
4. 도메인 기술: "직접 설계해야 함"
5. DNA 시스템: "전체에 영향, 일관성 핵심"
```

---

**버전 이력**:
- v5.0 (2025-12-03): Gemini 연구 기반 전면 재작성, DNA_METHODOLOGY_DETAILED.md 기준
- v3.0 (2025-11-13): Stage 3 분리
- v2.0 (2025-11-12): ADR 유형 구분
- v1.0 (2025-11-10): 초기 버전
